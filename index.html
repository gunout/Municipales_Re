<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyseur des √âlections Municipales 2020 - La R√©union</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background-color: #f5f7fa;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        body.dark-mode {
            background-color: #1a1a1a;
            color: #ffffff;
        }
        body.high-contrast {
            background-color: #000000;
            color: #ffffff;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 30px;
        }
        body.dark-mode .container {
            background-color: #2d2d2d;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        body.high-contrast .container {
            background-color: #000000;
            border: 3px solid #ffff00;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 15px;
        }
        body.dark-mode h1 {
            color: #ffffff;
        }
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        .file-upload {
            background-color: #f8f9fa;
            border: 2px dashed #3498db;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .file-upload:hover {
            background-color: #e8f4fc;
            border-color: #2980b9;
        }
        .file-upload input {
            display: none;
        }
        .file-upload label {
            display: block;
            cursor: pointer;
        }
        .upload-icon {
            font-size: 48px;
            color: #3498db;
            margin-bottom: 15px;
        }
        .upload-text {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .upload-subtext {
            color: #7f8c8d;
            font-size: 14px;
        }
        .file-name {
            margin-top: 15px;
            padding: 10px;
            background-color: #e8f4fc;
            border-radius: 5px;
            color: #3498db;
            font-weight: 600;
        }
        
        /* Navigation par onglets */
        .tabs {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
        }
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: #7f8c8d;
            transition: all 0.3s;
        }
        .tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
            background-color: #f8f9fa;
        }
        .tab:hover:not(.active) {
            background-color: #f5f7fa;
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Boutons d'action */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }
        .btn-secondary {
            background-color: #f8f9fa;
            color: #2c3e50;
            border: 2px solid #ddd;
        }
        .btn-secondary:hover {
            background-color: #e8e9ea;
        }
        .btn-success {
            background-color: #2ecc71;
            color: white;
        }
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
            align-items: center;
            display: none; /* Cach√© initialement */
        }
        .control-group {
            flex: 1;
            min-width: 200px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        select, input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        select:focus, input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        /* Filtres avanc√©s */
        .advanced-filters {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }
        .advanced-filters.show {
            display: block;
        }
        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        .filter-item {
            flex: 1;
            min-width: 150px;
        }
        
        .results-section {
            display: none;
            margin-top: 30px;
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .commune-header {
            background-color: #3498db;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            text-align: center;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            text-align: center;
            border-top: 5px solid #3498db;
            transition: all 0.3s ease;
        }
        body.dark-mode .stat-card {
            background-color: #3d3d3d;
            color: #ffffff;
        }
        body.high-contrast .stat-card {
            background-color: #000000;
            border: 3px solid #ffff00;
            color: #ffffff;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        .stat-card h3 {
            margin-top: 0;
            color: #2c3e50;
            font-size: 1.1em;
        }
        body.dark-mode .stat-card h3 {
            color: #ffffff;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }
        body.dark-mode .stat-value {
            color: #ffffff;
        }
        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        .stat-card.important {
            border-top-color: #e74c3c;
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .stat-card .trend {
            font-size: 0.9em;
            margin-top: 5px;
        }
        .trend.up {
            color: #2ecc71;
        }
        .trend.down {
            color: #e74c3c;
        }
        
        .chart-container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            height: 400px;
            position: relative;
            transition: all 0.3s ease;
        }
        body.dark-mode .chart-container {
            background-color: #3d3d3d;
        }
        .chart-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        .table-container {
            overflow-x: auto;
            margin-bottom: 30px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        body.dark-mode .table-container {
            background-color: #3d3d3d;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            background-color: #3498db;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        body.dark-mode td {
            border-bottom: 1px solid #555;
        }
        tr:hover {
            background-color: #f8f9fa;
        }
        body.dark-mode tr:hover {
            background-color: #444;
        }
        .winner {
            background-color: rgba(52, 152, 219, 0.1);
            font-weight: bold;
        }
        body.dark-mode .winner {
            background-color: rgba(52, 152, 219, 0.2);
        }
        .candidate-color {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        /* Info-bulles */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #2c3e50;
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 14px;
            font-weight: normal;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        /* L√©gende interactive */
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        body.dark-mode .legend {
            background-color: #3d3d3d;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .legend-item:hover {
            background-color: #e8e9ea;
        }
        body.dark-mode .legend-item:hover {
            background-color: #555;
        }
        .legend-item.hidden {
            opacity: 0.4;
        }
        
        /* Alertes */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }
        .alert-info {
            background-color: #e8f4fc;
            border-left-color: #3498db;
            color: #2c3e50;
        }
        .alert-success {
            background-color: #e8f8ef;
            border-left-color: #2ecc71;
            color: #2c3e50;
        }
        body.dark-mode .alert-info {
            background-color: #2c3e50;
            color: #ffffff;
        }
        body.dark-mode .alert-success {
            background-color: #1e824c;
            color: #ffffff;
        }
        
        .no-data {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
            font-size: 1.2em;
        }
        .loading {
            text-align: center;
            padding: 30px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Comparaisons */
        .comparison-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            color: #7f8c8d;
            font-size: 0.9em;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        body.dark-mode .footer {
            border-top: 1px solid #555;
        }
        
        /* √âtats de chargement am√©lior√©s */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .loading-content {
            background-color: white;
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            max-width: 400px;
        }
        
        /* Tooltips am√©lior√©s */
        .tooltip-enhanced {
            position: relative;
            display: inline-block;
            border-bottom: 1px dotted #3498db;
        }
        .tooltip-enhanced .tooltip-content {
            visibility: hidden;
            width: 300px;
            background-color: #2c3e50;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 15px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .tooltip-enhanced:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            .tabs {
                flex-direction: column;
            }
            .tab {
                text-align: center;
                border-bottom: none;
                border-left: 3px solid transparent;
            }
            .tab.active {
                border-left-color: #3498db;
            }
            .controls, .action-buttons, .comparison-controls {
                flex-direction: column;
            }
            .control-group, .btn {
                width: 100%;
            }
            .btn {
                justify-content: center;
            }
            .chart-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Analyseur des √âlections Municipales 2020 - La R√©union</h1>
        <div class="subtitle">Analyse avanc√©e des r√©sultats √©lectoraux avec visualisations interactives</div>
        
        <!-- Zone de t√©l√©chargement de fichier -->
        <div class="file-upload" id="file-upload-area">
            <input type="file" id="file-input" accept=".txt">
            <label for="file-input">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">Cliquez pour s√©lectionner votre fichier de r√©sultats</div>
                <div class="upload-subtext">Format attendu : fichier .txt avec les r√©sultats par bureau de vote</div>
                <div class="upload-subtext">(Utilisez le fichier : 2020-05-18-resultats-par-niveau-burvot-t1-france-La reunion.txt)</div>
            </label>
            <div class="file-name" id="file-name-display">Aucun fichier s√©lectionn√©</div>
        </div>
        
        <div class="loading" id="loading-indicator" style="display: none;">
            <div class="spinner"></div>
            <p>Chargement et analyse du fichier en cours...</p>
        </div>
        
        <!-- Boutons d'action rapide -->
        <div class="action-buttons" id="quick-actions" style="display: none;">
            <button class="btn btn-primary" id="compare-btn">
                <span>üîç</span> Comparer avec...
            </button>
            <button class="btn btn-secondary" id="export-btn">
                <span>üì•</span> Exporter les donn√©es
            </button>
            <button class="btn btn-secondary" id="toggle-advanced-filters">
                <span>‚öôÔ∏è</span> Filtres avanc√©s
            </button>
            <button class="btn btn-secondary" id="toggle-dark-mode">
                <span>üåô</span> Mode sombre
            </button>
            <button class="btn btn-secondary" id="toggle-accessibility">
                <span>‚ôø</span> Accessibilit√©
            </button>
        </div>
        
        <!-- Filtres avanc√©s (cach√©s par d√©faut) -->
        <div class="advanced-filters" id="advanced-filters">
            <h4>Filtres avanc√©s</h4>
            <div class="filter-group">
                <div class="filter-item">
                    <label for="filter-nuance">Nuance politique :</label>
                    <select id="filter-nuance">
                        <option value="">Toutes les nuances</option>
                        <option value="LDVD">Divers droite</option>
                        <option value="LDVG">Divers gauche</option>
                        <option value="LREM">La R√©publique En Marche</option>
                        <option value="LFI">La France Insoumise</option>
                        <option value="LR">Les R√©publicains</option>
                        <option value="SOC">Socialiste</option>
                        <option value="ECO">√âcologiste</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="filter-participation">Participation :</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" id="filter-participation-min" placeholder="Min %" min="0" max="100">
                        <span>√†</span>
                        <input type="number" id="filter-participation-max" placeholder="Max %" min="0" max="100">
                    </div>
                </div>
                <div class="filter-item">
                    <label for="filter-votes-min">Voix minimum :</label>
                    <input type="number" id="filter-votes-min" placeholder="Voix minimum">
                </div>
            </div>
        </div>
        
        <div class="controls" id="controls-section">
            <div class="control-group">
                <label for="commune-select">üèôÔ∏è S√©lectionnez une commune :</label>
                <select id="commune-select">
                    <option value="">-- Choisissez une commune --</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="bureau-select">üèõÔ∏è Bureau de vote (optionnel) :</label>
                <select id="bureau-select">
                    <option value="all">Tous les bureaux</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="candidate-filter">üë• Filtre candidat (optionnel) :</label>
                <input type="text" id="candidate-filter" placeholder="Nom du candidat...">
            </div>
        </div>
        
        <!-- Navigation par onglets -->
        <div class="tabs" id="main-tabs" style="display: none;">
            <div class="tab active" data-tab="overview">üìä Vue d'ensemble</div>
            <div class="tab" data-tab="details">üìã D√©tails par bureau</div>
            <div class="tab" data-tab="analysis">üîç Analyse avanc√©e</div>
            <div class="tab" data-tab="comparison">‚öñÔ∏è Comparaisons</div>
        </div>
        
        <!-- Contenu des onglets -->
        <div class="tab-content active" id="overview-tab">
            <div id="results-section" class="results-section">
                <div class="commune-header">
                    <h2 id="commune-name"></h2>
                    <p id="commune-info"></p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Inscrits</h3>
                        <div class="stat-value" id="stat-inscrits">0</div>
                        <div class="stat-label">√âlecteurs inscrits</div>
                    </div>
                    <div class="stat-card">
                        <h3>Participation</h3>
                        <div class="stat-value" id="stat-participation">0%</div>
                        <div class="stat-label">Taux de participation</div>
                    </div>
                    <div class="stat-card">
                        <h3>Abstention</h3>
                        <div class="stat-value" id="stat-abstention">0%</div>
                        <div class="stat-label">Taux d'abstention</div>
                    </div>
                    <div class="stat-card">
                        <h3>Blancs/Nuls</h3>
                        <div class="stat-value" id="stat-blancs-nuls">0%</div>
                        <div class="stat-label">Bulletins blancs et nuls</div>
                    </div>
                </div>
                
                <h3>üìà R√©sultats par candidat</h3>
                <div class="chart-container">
                    <canvas id="results-chart"></canvas>
                </div>
                
                <!-- L√©gende interactive -->
                <div class="legend" id="chart-legend">
                    <!-- G√©n√©r√©e dynamiquement -->
                </div>
                
                <h3>üèõÔ∏è Participation par bureau de vote</h3>
                <div class="chart-container">
                    <canvas id="participation-chart"></canvas>
                </div>
                
                <h3>üìã Tableau des r√©sultats d√©taill√©s</h3>
                <div class="table-container">
                    <table id="results-table">
                        <thead>
                            <tr>
                                <th>Bureau</th>
                                <th>Inscrits</th>
                                <th>Votants</th>
                                <th>Participation</th>
                                <th>Blancs/Nuls</th>
                                <th>Candidat</th>
                                <th>Voix</th>
                                <th>% Exprim√©s</th>
                                <th>% Inscrits</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body">
                            <!-- Les donn√©es seront ajout√©es dynamiquement -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="details-tab">
            <h3>üìã D√©tails bureau par bureau</h3>
            <div id="detailed-view">
                <!-- Sera rempli dynamiquement -->
            </div>
        </div>
        
        <div class="tab-content" id="analysis-tab">
            <h3>üîç Analyse avanc√©e</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Coefficient de Gini</h3>
                    <div class="stat-value" id="gini-coefficient">0.000</div>
                    <div class="stat-label">Mesure l'in√©galit√© des voix</div>
                </div>
                <div class="stat-card">
                    <h3>Indice Herfindahl</h3>
                    <div class="stat-value" id="herfindahl-index">0.000</div>
                    <div class="stat-label">Concentration des votes</div>
                </div>
                <div class="stat-card">
                    <h3>Bureaux pivot</h3>
                    <div class="stat-value" id="swing-bureaus">0</div>
                    <div class="stat-label">√âcart &lt; 5%</div>
                </div>
                <div class="stat-card">
                    <h3>Tendance participation</h3>
                    <div class="stat-value" id="participation-trend">0%</div>
                    <div class="stat-label" id="trend-label">Stable</div>
                </div>
            </div>
            
            <h4>Alertes et anomalies d√©tect√©es</h4>
            <div id="smart-alerts">
                <!-- Alertes g√©n√©r√©es dynamiquement -->
            </div>
            
            <h4>Analyse des tendances</h4>
            <div class="chart-container">
                <canvas id="trends-chart"></canvas>
            </div>
        </div>
        
        <div class="tab-content" id="comparison-tab">
            <h3>‚öñÔ∏è Comparaison entre communes</h3>
            <div class="comparison-controls">
                <select id="comparison-commune-1">
                    <option value="">S√©lectionner commune 1</option>
                </select>
                <select id="comparison-commune-2">
                    <option value="">S√©lectionner commune 2</option>
                </select>
                <button class="btn btn-primary" id="run-comparison">Comparer</button>
            </div>
            <div id="comparison-results">
                <!-- R√©sultats de comparaison -->
            </div>
        </div>
        
        <div id="no-data" class="no-data">
            <p>Chargez un fichier de r√©sultats pour commencer l'analyse.</p>
            <p>Le fichier doit √™tre au format texte (.txt) avec les r√©sultats des √©lections municipales 2020.</p>
        </div>
        
        <!-- Alertes contextuelles -->
        <div id="alerts-container">
            <!-- Alertes g√©n√©r√©es dynamiquement -->
        </div>
        
        <div class="footer">
            <p>Analyseur des √âlections Municipales 2020 - La R√©union | D√©velopp√© avec HTML, CSS et JavaScript</p>
            <p>¬© 2024 - Outil d'analyse √©lectorale avanc√©e</p>
        </div>
    </div>

    <script>
        // Variables globales
        let allData = [];
        let currentCommune = null;
        let currentBureau = 'all';
        let currentCandidateFilter = '';
        let resultsChart = null;
        let participationChart = null;
        let trendsChart = null;
        let colorPalette = [
            '#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', 
            '#1abc9c', '#d35400', '#c0392b', '#16a085', '#8e44ad',
            '#27ae60', '#f1c40f', '#e67e22', '#95a5a6', '#7f8c8d'
        ];
        
        // Initialisation de l'application
        function initApp() {
            // Configurer l'√©v√©nement pour le t√©l√©chargement de fichier
            const fileInput = document.getElementById('file-input');
            fileInput.addEventListener('change', handleFileSelect);
            
            // Ajouter les √©v√©nements pour les contr√¥les
            document.getElementById('commune-select').addEventListener('change', function() {
                if (this.value) {
                    currentCommune = this.value;
                    trackUsage('commune_selected', { commune: currentCommune });
                    updateBureauSelect();
                    updateResults();
                }
            });
            
            document.getElementById('bureau-select').addEventListener('change', function() {
                currentBureau = this.value;
                trackUsage('bureau_selected', { bureau: currentBureau });
                updateResults();
            });
            
            document.getElementById('candidate-filter').addEventListener('input', function() {
                currentCandidateFilter = this.value.toLowerCase();
                updateResults();
            });
            
            // Initialiser les onglets
            initTabs();
            
            // Initialiser les boutons d'action
            initActionButtons();
            
            // Initialiser les filtres avanc√©s
            initAdvancedFilters();
            
            // Initialiser le mode sombre
            initDarkMode();
            
            // Initialiser le mode accessibilit√©
            initAccessibilityMode();
            
            // Initialiser la comparaison
            initComparison();
            
            // Restaurer l'√©tat sauvegard√©
            restoreState();
            
            // Afficher le message initial
            document.getElementById('no-data').style.display = 'block';
            document.getElementById('results-section').style.display = 'none';
        }
        
        // G√©rer la s√©lection de fichier
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Afficher le nom du fichier
            document.getElementById('file-name-display').textContent = file.name;
            
            // Afficher l'indicateur de chargement
            document.getElementById('loading-indicator').style.display = 'block';
            document.getElementById('no-data').style.display = 'none';
            document.getElementById('results-section').style.display = 'none';
            document.getElementById('controls-section').style.display = 'none';
            document.getElementById('quick-actions').style.display = 'none';
            document.getElementById('main-tabs').style.display = 'none';
            
            // Lire le fichier
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    // Analyser les donn√©es
                    const fileContent = e.target.result;
                    allData = parseData(fileContent);
                    
                    // Masquer l'indicateur de chargement
                    document.getElementById('loading-indicator').style.display = 'none';
                    
                    // V√©rifier si des donn√©es ont √©t√© trouv√©es
                    if (allData.length > 0) {
                        trackUsage('file_loaded', { 
                            rows: allData.length, 
                            communes: new Set(allData.map(d => d.communeName)).size 
                        });
                        
                        // Remplir la liste des communes
                        populateCommuneSelect();
                        
                        // Afficher les contr√¥les et actions
                        document.getElementById('controls-section').style.display = 'flex';
                        document.getElementById('quick-actions').style.display = 'flex';
                        document.getElementById('main-tabs').style.display = 'flex';
                        
                        // Afficher un message pour s√©lectionner une commune
                        document.getElementById('no-data').style.display = 'block';
                        document.getElementById('no-data').innerHTML = `
                            <p>‚úÖ Fichier charg√© avec succ√®s !</p>
                            <p>${allData.length} bureaux de vote analys√©s.</p>
                            <p>S√©lectionnez une commune dans la liste ci-dessus pour voir les r√©sultats.</p>
                        `;
                        
                        // Remplir les listes de comparaison
                        populateComparisonSelects();
                    } else {
                        document.getElementById('no-data').style.display = 'block';
                        document.getElementById('no-data').innerHTML = `
                            <p>‚ùå Aucune donn√©e valide trouv√©e dans le fichier.</p>
                            <p>V√©rifiez le format du fichier et r√©essayez.</p>
                        `;
                    }
                } catch (error) {
                    console.error('Erreur lors de l\'analyse du fichier:', error);
                    trackUsage('file_error', { error: error.message });
                    document.getElementById('loading-indicator').style.display = 'none';
                    document.getElementById('no-data').style.display = 'block';
                    document.getElementById('no-data').innerHTML = `
                        <p>‚ùå Erreur lors de l'analyse du fichier.</p>
                        <p>D√©tails: ${error.message}</p>
                    `;
                }
            };
            
            reader.onerror = function() {
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('no-data').style.display = 'block';
                document.getElementById('no-data').innerHTML = `
                    <p>‚ùå Erreur lors de la lecture du fichier.</p>
                    <p>Veuillez r√©essayer.</p>
                `;
            };
            
            // Lire le fichier comme texte
            reader.readAsText(file);
        }
        
        // Fonction pour parser les donn√©es brutes
        function parseData(rawText) {
            const lines = rawText.split('\n');
            if (lines.length < 2) return [];
            
            const headers = lines[0].split('\t');
            const dataLines = lines.slice(1);
            
            const parsedData = [];
            
            dataLines.forEach(line => {
                if (line.trim() === '') return;
                
                const columns = line.split('\t');
                if (columns.length < 20) return; // Ligne trop courte
                
                // Extraire les informations de base
                const communeCode = columns[2];
                const communeName = columns[3];
                const bureauCode = columns[4];
                const inscrits = parseInt(columns[5]) || 0;
                const abstentions = parseInt(columns[6]) || 0;
                const votants = parseInt(columns[8]) || 0;
                const blancs = parseInt(columns[10]) || 0;
                const nuls = parseInt(columns[13]) || 0;
                const exprim√©s = parseInt(columns[16]) || 0;
                
                // Extraire les informations des candidats (jusqu'√† 10 candidats)
                const candidates = [];
                
                // Structure des colonnes pour chaque candidat
                // N.Pan., Code Nuance, Sexe, Nom, Pr√©nom, Liste, Voix, % Voix/Ins, % Voix/Exp
                const candidateColumnSize = 9;
                
                for (let i = 0; i < 10; i++) {
                    const startCol = 19 + (i * candidateColumnSize);
                    
                    // V√©rifier si nous avons assez de colonnes pour ce candidat
                    if (startCol + 8 < columns.length) {
                        const pan = columns[startCol] || '';
                        const nuance = columns[startCol + 1] || '';
                        const sexe = columns[startCol + 2] || '';
                        const nom = columns[startCol + 3] || '';
                        const prenom = columns[startCol + 4] || '';
                        const liste = columns[startCol + 5] || '';
                        const voixStr = columns[startCol + 6] || '0';
                        const pourcentInscritsStr = columns[startCol + 7] || '0';
                        const pourcentExprimesStr = columns[startCol + 8] || '0';
                        
                        // Nettoyer et convertir les nombres
                        const voix = parseInt(voixStr.replace(/\s/g, '')) || 0;
                        const pourcentInscrits = parseFloat(pourcentInscritsStr.replace(',', '.')) || 0;
                        const pourcentExprimes = parseFloat(pourcentExprimesStr.replace(',', '.')) || 0;
                        
                        // Si le candidat a au moins un nom, on l'ajoute
                        if (nom.trim() !== '' || liste.trim() !== '') {
                            candidates.push({
                                pan,
                                nuance,
                                sexe,
                                nom: nom.trim(),
                                prenom: prenom.trim(),
                                liste: liste.trim(),
                                voix,
                                pourcentInscrits,
                                pourcentExprimes,
                                fullName: `${prenom} ${nom}`.trim() || liste
                            });
                        }
                    }
                }
                
                // Ajouter les donn√©es √† notre tableau
                parsedData.push({
                    communeCode,
                    communeName,
                    bureauCode,
                    inscrits,
                    abstentions,
                    votants,
                    blancs,
                    nuls,
                    exprim√©s,
                    candidates
                });
            });
            
            return parsedData;
        }
        
        // Remplir la liste des communes
        function populateCommuneSelect() {
            const communeSelect = document.getElementById('commune-select');
            communeSelect.innerHTML = '<option value="">-- Choisissez une commune --</option>';
            
            const communes = [...new Set(allData.map(item => item.communeName))].sort();
            
            communes.forEach(commune => {
                const option = document.createElement('option');
                option.value = commune;
                option.textContent = commune;
                communeSelect.appendChild(option);
            });
        }
        
        // Initialiser les onglets
        function initTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Retirer la classe active de tous les onglets
                    tabs.forEach(t => t.classList.remove('active'));
                    
                    // Ajouter la classe active √† l'onglet cliqu√©
                    this.classList.add('active');
                    
                    // Afficher le contenu correspondant
                    const tabId = this.getAttribute('data-tab');
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // Tracker l'usage
                    trackUsage('tab_switched', { tab: tabId });
                });
            });
        }
        
        // Initialiser les boutons d'action
        function initActionButtons() {
            // Export des donn√©es
            document.getElementById('export-btn').addEventListener('click', function() {
                trackUsage('export_clicked');
                exportToExcel();
            });
            
            // Comparaison
            document.getElementById('compare-btn').addEventListener('click', function() {
                // Passer √† l'onglet comparaison
                document.querySelector('.tab[data-tab="comparison"]').click();
            });
        }
        
        // Initialiser les filtres avanc√©s
        function initAdvancedFilters() {
            const toggleBtn = document.getElementById('toggle-advanced-filters');
            const filtersDiv = document.getElementById('advanced-filters');
            
            toggleBtn.addEventListener('click', function() {
                filtersDiv.classList.toggle('show');
                this.textContent = filtersDiv.classList.contains('show') 
                    ? 'Masquer les filtres avanc√©s ‚ñº' 
                    : 'Afficher les filtres avanc√©s ‚ñ∂';
                trackUsage('advanced_filters_toggled', { show: filtersDiv.classList.contains('show') });
            });
            
            // Ajouter les √©v√©nements pour les filtres avanc√©s
            document.getElementById('filter-nuance').addEventListener('change', updateResults);
            document.getElementById('filter-participation-min').addEventListener('input', updateResults);
            document.getElementById('filter-participation-max').addEventListener('input', updateResults);
            document.getElementById('filter-votes-min').addEventListener('input', updateResults);
        }
        
        // Initialiser le mode sombre
        function initDarkMode() {
            const toggleBtn = document.getElementById('toggle-dark-mode');
            
            toggleBtn.addEventListener('click', function() {
                document.body.classList.toggle('dark-mode');
                localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
                trackUsage('dark_mode_toggled', { enabled: document.body.classList.contains('dark-mode') });
            });
            
            // Restaurer depuis localStorage
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
            }
        }
        
        // Initialiser le mode accessibilit√©
        function initAccessibilityMode() {
            const toggleBtn = document.getElementById('toggle-accessibility');
            
            toggleBtn.addEventListener('click', function() {
                document.body.classList.toggle('high-contrast');
                localStorage.setItem('highContrastMode', document.body.classList.contains('high-contrast'));
                trackUsage('accessibility_toggled', { enabled: document.body.classList.contains('high-contrast') });
            });
            
            // Restaurer depuis localStorage
            if (localStorage.getItem('highContrastMode') === 'true') {
                document.body.classList.add('high-contrast');
            }
        }
        
        // Initialiser la comparaison
        function initComparison() {
            document.getElementById('run-comparison').addEventListener('click', function() {
                const commune1 = document.getElementById('comparison-commune-1').value;
                const commune2 = document.getElementById('comparison-commune-2').value;
                
                if (commune1 && commune2) {
                    runComparison(commune1, commune2);
                } else {
                    alert('Veuillez s√©lectionner deux communes √† comparer');
                }
            });
        }
        
        // Remplir les listes de comparaison
        function populateComparisonSelects() {
            const commune1Select = document.getElementById('comparison-commune-1');
            const commune2Select = document.getElementById('comparison-commune-2');
            
            commune1Select.innerHTML = '<option value="">S√©lectionner commune 1</option>';
            commune2Select.innerHTML = '<option value="">S√©lectionner commune 2</option>';
            
            const communes = [...new Set(allData.map(item => item.communeName))].sort();
            
            communes.forEach(commune => {
                const option1 = document.createElement('option');
                option1.value = commune;
                option1.textContent = commune;
                commune1Select.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = commune;
                option2.textContent = commune;
                commune2Select.appendChild(option2);
            });
        }
        
        // Sauvegarde automatique des filtres
        function saveState() {
            const state = {
                commune: currentCommune,
                bureau: currentBureau,
                candidateFilter: currentCandidateFilter,
                darkMode: document.body.classList.contains('dark-mode'),
                highContrast: document.body.classList.contains('high-contrast')
            };
            localStorage.setItem('electionAnalyzerState', JSON.stringify(state));
        }
        
        function restoreState() {
            const saved = localStorage.getItem('electionAnalyzerState');
            if (saved) {
                const state = JSON.parse(saved);
                // Restaurer les modes d'affichage
                if (state.darkMode) {
                    document.body.classList.add('dark-mode');
                }
                if (state.highContrast) {
                    document.body.classList.add('high-contrast');
                }
            }
        }
        
        // Mettre √† jour la liste des bureaux de vote
        function updateBureauSelect() {
            const bureauSelect = document.getElementById('bureau-select');
            bureauSelect.innerHTML = '<option value="all">Tous les bureaux</option>';
            
            const bureaux = [...new Set(allData
                .filter(item => item.communeName === currentCommune)
                .map(item => item.bureauCode))].sort((a, b) => a - b);
            
            bureaux.forEach(bureau => {
                const option = document.createElement('option');
                option.value = bureau;
                option.textContent = `Bureau ${bureau}`;
                bureauSelect.appendChild(option);
            });
            
            currentBureau = 'all';
        }
        
        // Mettre √† jour les r√©sultats affich√©s
        function updateResults() {
            if (!currentCommune) return;
            
            // Sauvegarder l'√©tat
            saveState();
            
            // Filtrer les donn√©es selon la commune et le bureau s√©lectionn√©
            let filteredData = allData.filter(item => item.communeName === currentCommune);
            
            if (currentBureau !== 'all') {
                filteredData = filteredData.filter(item => item.bureauCode === currentBureau);
            }
            
            // Appliquer les filtres avanc√©s
            filteredData = applyAdvancedFilters(filteredData);
            
            if (filteredData.length === 0) {
                document.getElementById('no-data').style.display = 'block';
                document.getElementById('results-section').style.display = 'none';
                return;
            }
            
            // Afficher la section des r√©sultats
            document.getElementById('no-data').style.display = 'none';
            document.getElementById('results-section').style.display = 'block';
            
            // Mettre √† jour le nom de la commune
            document.getElementById('commune-name').textContent = currentCommune;
            document.getElementById('commune-info').textContent = currentBureau === 'all' 
                ? `R√©sultats pour tous les bureaux de vote (${filteredData.length} bureau(s))`
                : `R√©sultats pour le bureau de vote ${currentBureau}`;
            
            // Calculer les statistiques globales
            let totalInscrits = 0;
            let totalVotants = 0;
            let totalAbstentions = 0;
            let totalBlancs = 0;
            let totalNuls = 0;
            let totalExprimes = 0;
            
            filteredData.forEach(item => {
                totalInscrits += item.inscrits;
                totalVotants += item.votants;
                totalAbstentions += item.abstentions;
                totalBlancs += item.blancs;
                totalNuls += item.nuls;
                totalExprimes += item.exprim√©s;
            });
            
            const tauxParticipation = totalInscrits > 0 ? (totalVotants / totalInscrits * 100).toFixed(1) : 0;
            const tauxAbstention = totalInscrits > 0 ? (totalAbstentions / totalInscrits * 100).toFixed(1) : 0;
            const tauxBlancsNuls = totalVotants > 0 ? ((totalBlancs + totalNuls) / totalVotants * 100).toFixed(1) : 0;
            
            // Mettre √† jour les statistiques
            document.getElementById('stat-inscrits').textContent = totalInscrits.toLocaleString();
            document.getElementById('stat-participation').textContent = `${tauxParticipation}%`;
            document.getElementById('stat-abstention').textContent = `${tauxAbstention}%`;
            document.getElementById('stat-blancs-nuls').textContent = `${tauxBlancsNuls}%`;
            
            // Pr√©parer les donn√©es pour les graphiques
            prepareChartData(filteredData);
            prepareParticipationChart(filteredData);
            updateResultsTable(filteredData);
            
            // Mettre √† jour l'analyse avanc√©e
            updateAdvancedAnalysis(filteredData);
            
            // G√©n√©rer les alertes intelligentes
            generateSmartAlerts(filteredData);
            
            // Mettre √† jour la l√©gende
            updateChartLegend(filteredData);
        }
        
        // Appliquer les filtres avanc√©s
        function applyAdvancedFilters(data) {
            let filteredData = [...data];
            
            // Filtre par nuance politique
            const nuanceFilter = document.getElementById('filter-nuance').value;
            if (nuanceFilter) {
                filteredData = filteredData.map(item => {
                    const filteredCandidates = item.candidates.filter(candidate => 
                        candidate.nuance === nuanceFilter
                    );
                    return { ...item, candidates: filteredCandidates };
                }).filter(item => item.candidates.length > 0);
            }
            
            // Filtre par participation
            const participationMin = document.getElementById('filter-participation-min').value;
            const participationMax = document.getElementById('filter-participation-max').value;
            
            if (participationMin || participationMax) {
                filteredData = filteredData.filter(item => {
                    const participation = item.inscrits > 0 ? (item.votants / item.inscrits * 100) : 0;
                    const min = participationMin ? parseFloat(participationMin) : 0;
                    const max = participationMax ? parseFloat(participationMax) : 100;
                    return participation >= min && participation <= max;
                });
            }
            
            // Filtre par voix minimum
            const votesMin = document.getElementById('filter-votes-min').value;
            if (votesMin) {
                const minVotes = parseInt(votesMin);
                filteredData = filteredData.map(item => {
                    const filteredCandidates = item.candidates.filter(candidate => 
                        candidate.voix >= minVotes
                    );
                    return { ...item, candidates: filteredCandidates };
                }).filter(item => item.candidates.length > 0);
            }
            
            return filteredData;
        }
        
        // Pr√©parer les donn√©es pour le graphique des r√©sultats par candidat
        function prepareChartData(data) {
            // Agr√©gation des voix par candidat
            const candidateVotes = {};
            
            data.forEach(item => {
                item.candidates.forEach(candidate => {
                    // Filtrer par nom de candidat si un filtre est appliqu√©
                    if (currentCandidateFilter && 
                        !candidate.fullName.toLowerCase().includes(currentCandidateFilter) &&
                        !candidate.liste.toLowerCase().includes(currentCandidateFilter)) {
                        return;
                    }
                    
                    const key = candidate.fullName;
                    if (!candidateVotes[key]) {
                        candidateVotes[key] = {
                            fullName: candidate.fullName,
                            liste: candidate.liste,
                            nuance: candidate.nuance,
                            totalVoix: 0,
                            totalPourcent: 0,
                            count: 0
                        };
                    }
                    
                    candidateVotes[key].totalVoix += candidate.voix;
                    candidateVotes[key].totalPourcent += candidate.pourcentExprimes;
                    candidateVotes[key].count++;
                });
            });
            
            // Convertir en tableau et trier par nombre de voix
            const candidatesArray = Object.values(candidateVotes).sort((a, b) => b.totalVoix - a.totalVoix);
            
            // Calculer les pourcentages moyens
            candidatesArray.forEach(candidate => {
                candidate.avgPourcent = candidate.count > 0 ? candidate.totalPourcent / candidate.count : 0;
            });
            
            // Limiter √† 10 candidats maximum pour la lisibilit√©
            const topCandidates = candidatesArray.slice(0, 10);
            
            // Cr√©er ou mettre √† jour le graphique
            const ctx = document.getElementById('results-chart').getContext('2d');
            
            if (resultsChart) {
                resultsChart.destroy();
            }
            
            // Pr√©parer les donn√©es pour le graphique
            const labels = topCandidates.map(c => {
                // Limiter la longueur du libell√© pour une meilleure lisibilit√©
                const name = c.fullName.length > 20 ? c.fullName.substring(0, 20) + '...' : c.fullName;
                return `${name} (${c.liste.substring(0, 15)}${c.liste.length > 15 ? '...' : ''})`;
            });
            
            const voixData = topCandidates.map(c => c.totalVoix);
            const colors = topCandidates.map((_, i) => colorPalette[i % colorPalette.length]);
            
            resultsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Voix obtenues',
                        data: voixData,
                        backgroundColor: colors,
                        borderColor: colors.map(c => c.replace('0.8', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const candidate = topCandidates[context.dataIndex];
                                    return [
                                        `Voix: ${candidate.totalVoix.toLocaleString()}`,
                                        `Moyenne: ${candidate.avgPourcent.toFixed(1)}% des exprim√©s`,
                                        `Liste: ${candidate.liste}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Nombre de voix'
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
            
            // Mettre √† jour la l√©gende
            updateChartLegendForCandidates(topCandidates);
        }
        
        // Mettre √† jour la l√©gende du graphique
        function updateChartLegendForCandidates(candidates) {
            const legendContainer = document.getElementById('chart-legend');
            legendContainer.innerHTML = '';
            
            candidates.forEach((candidate, index) => {
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.innerHTML = `
                    <div class="candidate-color" style="background-color: ${colorPalette[index % colorPalette.length]}"></div>
                    <span>${candidate.fullName}</span>
                `;
                
                // Ajouter un √©v√©nement pour masquer/afficher la s√©rie
                legendItem.addEventListener('click', function() {
                    this.classList.toggle('hidden');
                    const isHidden = this.classList.contains('hidden');
                    
                    // Masquer/afficher la s√©rie dans le graphique
                    if (resultsChart) {
                        resultsChart.data.datasets[0].backgroundColor[index] = isHidden 
                            ? 'rgba(200, 200, 200, 0.2)' 
                            : colorPalette[index % colorPalette.length];
                        resultsChart.data.datasets[0].borderColor[index] = isHidden 
                            ? 'rgba(200, 200, 200, 0.5)' 
                            : colorPalette[index % colorPalette.length];
                        resultsChart.update();
                    }
                });
                
                legendContainer.appendChild(legendItem);
            });
        }
        
        // Mettre √† jour la l√©gende
        function updateChartLegend(data) {
            // Cette fonction peut √™tre √©tendue pour d'autres types de l√©gendes
        }
        
        // Pr√©parer le graphique de participation par bureau
        function prepareParticipationChart(data) {
            // Trier les bureaux par code
            const sortedData = [...data].sort((a, b) => a.bureauCode - b.bureauCode);
            
            const ctx = document.getElementById('participation-chart').getContext('2d');
            
            if (participationChart) {
                participationChart.destroy();
            }
            
            const labels = sortedData.map(item => `Bureau ${item.bureauCode}`);
            const participationData = sortedData.map(item => {
                return item.inscrits > 0 ? (item.votants / item.inscrits * 100).toFixed(1) : 0;
            });
            const abstentionData = sortedData.map(item => {
                return item.inscrits > 0 ? (item.abstentions / item.inscrits * 100).toFixed(1) : 0;
            });
            
            participationChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Participation (%)',
                            data: participationData,
                            backgroundColor: 'rgba(52, 152, 219, 0.7)',
                            borderColor: 'rgba(52, 152, 219, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Abstention (%)',
                            data: abstentionData,
                            backgroundColor: 'rgba(231, 76, 60, 0.7)',
                            borderColor: 'rgba(231, 76, 60, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Pourcentage (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Bureau de vote'
                            }
                        }
                    }
                }
            });
        }
        
        // Mettre √† jour le tableau des r√©sultats d√©taill√©s
        function updateResultsTable(data) {
            const tableBody = document.getElementById('results-table-body');
            tableBody.innerHTML = '';
            
            // Trier les donn√©es par bureau
            const sortedData = [...data].sort((a, b) => a.bureauCode - b.bureauCode);
            
            sortedData.forEach(item => {
                // Calculer les taux pour ce bureau
                const tauxParticipation = item.inscrits > 0 ? (item.votants / item.inscrits * 100).toFixed(1) : 0;
                const tauxBlancsNuls = item.votants > 0 ? ((item.blancs + item.nuls) / item.votants * 100).toFixed(1) : 0;
                
                // Trouver le gagnant de ce bureau (celui avec le plus de voix)
                let winner = null;
                if (item.candidates.length > 0) {
                    winner = item.candidates.reduce((prev, current) => 
                        prev.voix > current.voix ? prev : current
                    );
                }
                
                // Ajouter une ligne pour chaque candidat
                item.candidates.forEach((candidate, index) => {
                    // Filtrer par nom de candidat si un filtre est appliqu√©
                    if (currentCandidateFilter && 
                        !candidate.fullName.toLowerCase().includes(currentCandidateFilter) &&
                        !candidate.liste.toLowerCase().includes(currentCandidateFilter)) {
                        return;
                    }
                    
                    const isWinner = winner && candidate.fullName === winner.fullName;
                    const rowClass = isWinner ? 'winner' : '';
                    
                    const row = document.createElement('tr');
                    if (rowClass) row.className = rowClass;
                    
                    // Pour le premier candidat, afficher les informations du bureau
                    if (index === 0) {
                        row.innerHTML = `
                            <td rowspan="${item.candidates.length}"><strong>Bureau ${item.bureauCode}</strong></td>
                            <td rowspan="${item.candidates.length}">${item.inscrits.toLocaleString()}</td>
                            <td rowspan="${item.candidates.length}">${item.votants.toLocaleString()}</td>
                            <td rowspan="${item.candidates.length}">${tauxParticipation}%</td>
                            <td rowspan="${item.candidates.length}">${tauxBlancsNuls}%</td>
                            <td>
                                <div class="candidate-color" style="background-color: ${colorPalette[index % colorPalette.length]}"></div>
                                ${candidate.fullName}<br>
                                <small>${candidate.liste}</small>
                            </td>
                            <td>${candidate.voix.toLocaleString()}</td>
                            <td>${candidate.pourcentExprimes.toFixed(1)}%</td>
                            <td>${candidate.pourcentInscrits.toFixed(1)}%</td>
                        `;
                    } else {
                        row.innerHTML = `
                            <td>
                                <div class="candidate-color" style="background-color: ${colorPalette[index % colorPalette.length]}"></div>
                                ${candidate.fullName}<br>
                                <small>${candidate.liste}</small>
                            </td>
                            <td>${candidate.voix.toLocaleString()}</td>
                            <td>${candidate.pourcentExprimes.toFixed(1)}%</td>
                            <td>${candidate.pourcentInscrits.toFixed(1)}%</td>
                        `;
                    }
                    
                    tableBody.appendChild(row);
                });
            });
        }
        
        // Mettre √† jour l'analyse avanc√©e
        function updateAdvancedAnalysis(data) {
            // Calculer le coefficient de Gini
            const gini = calculateGiniCoefficient(data);
            document.getElementById('gini-coefficient').textContent = gini;
            
            // Calculer l'indice Herfindahl
            const herfindahl = calculateHerfindahlIndex(data);
            document.getElementById('herfindahl-index').textContent = herfindahl;
            
            // D√©tecter les bureaux pivot
            const swingBureaus = detectSwingBureaus(data);
            document.getElementById('swing-bureaus').textContent = swingBureaus.length;
            
            // Analyser les tendances de participation
            const trends = calculateParticipationTrend(data);
            if (trends) {
                document.getElementById('participation-trend').textContent = `${trends.average}%`;
                const trendLabel = document.getElementById('trend-label');
                trendLabel.textContent = trends.trend;
                trendLabel.className = `trend ${trends.average > 50 ? 'up' : 'down'}`;
            }
            
            // Mettre √† jour le graphique des tendances
            updateTrendsChart(data);
        }
        
        // Calculer le coefficient de Gini
        function calculateGiniCoefficient(data) {
            const allVotes = [];
            data.forEach(item => {
                item.candidates.forEach(candidate => {
                    allVotes.push(candidate.voix);
                });
            });
            
            if (allVotes.length === 0) return "0.000";
            
            allVotes.sort((a, b) => a - b);
            const n = allVotes.length;
            const sum = allVotes.reduce((a, b) => a + b, 0);
            
            let cumulativeSum = 0;
            let giniSum = 0;
            
            for (let i = 0; i < n; i++) {
                cumulativeSum += allVotes[i];
                giniSum += (i + 1) * allVotes[i];
            }
            
            const gini = (2 * giniSum) / (n * sum) - (n + 1) / n;
            return gini.toFixed(3);
        }
        
        // Calculer l'indice Herfindahl
        function calculateHerfindahlIndex(data) {
            let totalVotes = 0;
            const candidateVotes = {};
            
            data.forEach(item => {
                item.candidates.forEach(candidate => {
                    totalVotes += candidate.voix;
                    if (!candidateVotes[candidate.fullName]) {
                        candidateVotes[candidate.fullName] = 0;
                    }
                    candidateVotes[candidate.fullName] += candidate.voix;
                });
            });
            
            if (totalVotes === 0) return "0.000";
            
            let herfindahl = 0;
            Object.values(candidateVotes).forEach(votes => {
                const share = votes / totalVotes;
                herfindahl += share * share;
            });
            
            return herfindahl.toFixed(3);
        }
        
        // D√©tecter les bureaux pivot
        function detectSwingBureaus(data) {
            const swingBureaus = [];
            
            data.forEach(item => {
                if (item.candidates.length < 2) return;
                
                const sortedCandidates = [...item.candidates].sort((a, b) => b.voix - a.voix);
                
                if (sortedCandidates.length >= 2) {
                    const totalVoix = sortedCandidates.reduce((sum, c) => sum + c.voix, 0);
                    const gap = totalVoix > 0 ? ((sortedCandidates[0].voix - sortedCandidates[1].voix) / totalVoix * 100) : 0;
                    
                    if (gap < 5 && totalVoix > 0) {
                        swingBureaus.push({
                            bureau: item.bureauCode,
                            gap: gap.toFixed(1),
                            winner: sortedCandidates[0].fullName,
                            runnerUp: sortedCandidates[1].fullName
                        });
                    }
                }
            });
            
            return swingBureaus;
        }
        
        // Calculer les tendances de participation
        function calculateParticipationTrend(data) {
            if (data.length < 2) return null;
            
            const participations = data.map(item => 
                item.inscrits > 0 ? (item.votants / item.inscrits * 100) : 0
            );
            
            const avg = participations.reduce((a, b) => a + b, 0) / participations.length;
            const variance = participations.reduce((a, b) => a + Math.pow(b - avg, 2), 0) / participations.length;
            const stdDev = Math.sqrt(variance);
            
            return {
                average: avg.toFixed(1),
                standardDeviation: stdDev.toFixed(1),
                min: Math.min(...participations).toFixed(1),
                max: Math.max(...participations).toFixed(1),
                trend: avg > 50 ? 'Haute' : 'Basse'
            };
        }
        
        // Mettre √† jour le graphique des tendances
        function updateTrendsChart(data) {
            const ctx = document.getElementById('trends-chart').getContext('2d');
            
            if (trendsChart) {
                trendsChart.destroy();
            }
            
            // Trier les bureaux par participation
            const sortedData = [...data].sort((a, b) => {
                const partA = a.inscrits > 0 ? (a.votants / a.inscrits * 100) : 0;
                const partB = b.inscrits > 0 ? (b.votants / b.inscrits * 100) : 0;
                return partA - partB;
            });
            
            const labels = sortedData.map(item => `Bureau ${item.bureauCode}`);
            const participationData = sortedData.map(item => 
                item.inscrits > 0 ? (item.votants / item.inscrits * 100) : 0
            );
            
            trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Participation (%)',
                        data: participationData,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Participation (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Bureaux de vote (tri√©s par participation)'
                            }
                        }
                    }
                }
            });
        }
        
        // G√©n√©rer des alertes intelligentes
        function generateSmartAlerts(data) {
            const alertsContainer = document.getElementById('smart-alerts');
            alertsContainer.innerHTML = '';
            
            const alerts = [];
            
            data.forEach(item => {
                const participation = item.inscrits > 0 ? (item.votants / item.inscrits * 100) : 0;
                
                // Participation anormalement basse
                if (participation < 30) {
                    alerts.push({
                        type: 'warning',
                        message: `Participation tr√®s basse au bureau ${item.bureauCode}: ${participation.toFixed(1)}%`,
                        bureau: item.bureauCode
                    });
                }
                
                // Taux de bulletins blancs/nuls √©lev√©
                const blancsNulsRate = item.votants > 0 ? ((item.blancs + item.nuls) / item.votants * 100) : 0;
                if (blancsNulsRate > 10) {
                    alerts.push({
                        type: 'info',
                        message: `Taux √©lev√© de blancs/nuls au bureau ${item.bureauCode}: ${blancsNulsRate.toFixed(1)}%`,
                        bureau: item.bureauCode
                    });
                }
                
                // Victoire √©crasante
                if (item.candidates.length > 0) {
                    const sortedCandidates = [...item.candidates].sort((a, b) => b.voix - a.voix);
                    const totalVoix = sortedCandidates.reduce((sum, c) => sum + c.voix, 0);
                    
                    if (totalVoix > 0 && sortedCandidates[0].voix / totalVoix > 0.6) {
                        alerts.push({
                            type: 'success',
                            message: `Victoire √©crasante de ${sortedCandidates[0].fullName} au bureau ${item.bureauCode}: ${(sortedCandidates[0].voix / totalVoix * 100).toFixed(1)}%`,
                            bureau: item.bureauCode
                        });
                    }
                }
            });
            
            // Limiter √† 5 alertes maximum
            const displayAlerts = alerts.slice(0, 5);
            
            displayAlerts.forEach(alert => {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${alert.type === 'warning' ? 'info' : alert.type === 'info' ? 'info' : 'success'}`;
                alertDiv.textContent = alert.message;
                alertsContainer.appendChild(alertDiv);
            });
            
            if (displayAlerts.length === 0) {
                const noAlertsDiv = document.createElement('div');
                noAlertsDiv.className = 'alert alert-info';
                noAlertsDiv.textContent = 'Aucune anomalie d√©tect√©e dans les donn√©es analys√©es.';
                alertsContainer.appendChild(noAlertsDiv);
            }
        }
        
        // Ex√©cuter une comparaison entre communes
        function runComparison(commune1, commune2) {
            const commune1Data = allData.filter(item => item.communeName === commune1);
            const commune2Data = allData.filter(item => item.communeName === commune2);
            
            const resultsContainer = document.getElementById('comparison-results');
            resultsContainer.innerHTML = '';
            
            if (commune1Data.length === 0 || commune2Data.length === 0) {
                resultsContainer.innerHTML = '<div class="alert alert-info">Donn√©es insuffisantes pour la comparaison</div>';
                return;
            }
            
            // Calculer les statistiques pour chaque commune
            const stats1 = calculateCommuneStats(commune1Data);
            const stats2 = calculateCommuneStats(commune2Data);
            
            // Cr√©er le tableau de comparaison
            const comparisonTable = document.createElement('table');
            comparisonTable.className = 'table-container';
            comparisonTable.innerHTML = `
                <thead>
                    <tr>
                        <th>Statistique</th>
                        <th>${commune1}</th>
                        <th>${commune2}</th>
                        <th>Diff√©rence</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Nombre de bureaux</td>
                        <td>${stats1.bureaux}</td>
                        <td>${stats2.bureaux}</td>
                        <td>${stats1.bureaux - stats2.bureaux}</td>
                    </tr>
                    <tr>
                        <td>Inscrits total</td>
                        <td>${stats1.inscrits.toLocaleString()}</td>
                        <td>${stats2.inscrits.toLocaleString()}</td>
                        <td>${(stats1.inscrits - stats2.inscrits).toLocaleString()}</td>
                    </tr>
                    <tr>
                        <td>Participation moyenne</td>
                        <td>${stats1.participationMoyenne}%</td>
                        <td>${stats2.participationMoyenne}%</td>
                        <td>${(stats1.participationMoyenne - stats2.participationMoyenne).toFixed(1)}%</td>
                    </tr>
                    <tr>
                        <td>Taux d'abstention</td>
                        <td>${stats1.abstentionMoyenne}%</td>
                        <td>${stats2.abstentionMoyenne}%</td>
                        <td>${(stats1.abstentionMoyenne - stats2.abstentionMoyenne).toFixed(1)}%</td>
                    </tr>
                    <tr>
                        <td>Blancs/Nuls moyen</td>
                        <td>${stats1.blancsNulsMoyen}%</td>
                        <td>${stats2.blancsNulsMoyen}%</td>
                        <td>${(stats1.blancsNulsMoyen - stats2.blancsNulsMoyen).toFixed(1)}%</td>
                    </tr>
                </tbody>
            `;
            
            resultsContainer.appendChild(comparisonTable);
            
            // Ajouter une analyse qualitative
            const analysisDiv = document.createElement('div');
            analysisDiv.className = 'alert alert-info';
            analysisDiv.innerHTML = `
                <h4>Analyse comparative</h4>
                <p>${generateComparisonAnalysis(stats1, stats2, commune1, commune2)}</p>
            `;
            resultsContainer.appendChild(analysisDiv);
            
            trackUsage('comparison_run', { commune1, commune2 });
        }
        
        // Calculer les statistiques d'une commune
        function calculateCommuneStats(data) {
            let totalInscrits = 0;
            let totalVotants = 0;
            let totalAbstentions = 0;
            let totalBlancs = 0;
            let totalNuls = 0;
            let totalExprimes = 0;
            
            data.forEach(item => {
                totalInscrits += item.inscrits;
                totalVotants += item.votants;
                totalAbstentions += item.abstentions;
                totalBlancs += item.blancs;
                totalNuls += item.nuls;
                totalExprimes += item.exprim√©s;
            });
            
            const participationMoyenne = totalInscrits > 0 ? (totalVotants / totalInscrits * 100).toFixed(1) : 0;
            const abstentionMoyenne = totalInscrits > 0 ? (totalAbstentions / totalInscrits * 100).toFixed(1) : 0;
            const blancsNulsMoyen = totalVotants > 0 ? ((totalBlancs + totalNuls) / totalVotants * 100).toFixed(1) : 0;
            
            return {
                bureaux: data.length,
                inscrits: totalInscrits,
                votants: totalVotants,
                abstentions: totalAbstentions,
                blancs: totalBlancs,
                nuls: totalNuls,
                exprim√©s: totalExprimes,
                participationMoyenne,
                abstentionMoyenne,
                blancsNulsMoyen
            };
        }
        
        // G√©n√©rer une analyse qualitative de la comparaison
        function generateComparisonAnalysis(stats1, stats2, commune1, commune2) {
            let analysis = "";
            
            // Comparaison de la participation
            if (Math.abs(stats1.participationMoyenne - stats2.participationMoyenne) > 5) {
                if (stats1.participationMoyenne > stats2.participationMoyenne) {
                    analysis += `${commune1} a une participation significativement plus √©lev√©e que ${commune2} (${stats1.participationMoyenne}% vs ${stats2.participationMoyenne}%). `;
                } else {
                    analysis += `${commune2} a une participation significativement plus √©lev√©e que ${commune1} (${stats2.participationMoyenne}% vs ${stats1.participationMoyenne}%). `;
                }
            } else {
                analysis += `Les deux communes ont des taux de participation similaires. `;
            }
            
            // Comparaison des abstentions
            if (Math.abs(stats1.abstentionMoyenne - stats2.abstentionMoyenne) > 5) {
                analysis += `L'abstention est ${stats1.abstentionMoyenne > stats2.abstentionMoyenne ? 'plus √©lev√©e' : 'plus basse'} √† ${commune1}. `;
            }
            
            // Comparaison des bulletins blancs/nuls
            if (Math.abs(stats1.blancsNulsMoyen - stats2.blancsNulsMoyen) > 2) {
                analysis += `Le taux de bulletins blancs/nuls est ${stats1.blancsNulsMoyen > stats2.blancsNulsMoyen ? 'plus important' : 'moins important'} √† ${commune1}. `;
            }
            
            // Comparaison de la taille √©lectorale
            if (stats1.inscrits > stats2.inscrits * 1.5) {
                analysis += `${commune1} est significativement plus grande que ${commune2} en nombre d'√©lecteurs. `;
            } else if (stats2.inscrits > stats1.inscrits * 1.5) {
                analysis += `${commune2} est significativement plus grande que ${commune1} en nombre d'√©lecteurs. `;
            }
            
            return analysis || "Les deux communes pr√©sentent des caract√©ristiques √©lectorales similaires.";
        }
        
        // Exporter vers Excel
        function exportToExcel() {
            if (!currentCommune) {
                alert('Veuillez d\'abord s√©lectionner une commune');
                return;
            }
            
            try {
                // Filtrer les donn√©es actuelles
                let filteredData = allData.filter(item => item.communeName === currentCommune);
                
                if (currentBureau !== 'all') {
                    filteredData = filteredData.filter(item => item.bureauCode === currentBureau);
                }
                
                // Transformer les donn√©es pour l'export
                const exportData = [];
                
                filteredData.forEach(item => {
                    item.candidates.forEach(candidate => {
                        exportData.push({
                            Commune: item.communeName,
                            Bureau: item.bureauCode,
                            Inscrits: item.inscrits,
                            Votants: item.votants,
                            Abstentions: item.abstentions,
                            'Blancs/Nuls': item.blancs + item.nuls,
                            Candidat: candidate.fullName,
                            Liste: candidate.liste,
                            Nuance: candidate.nuance,
                            Voix: candidate.voix,
                            '% Exprim√©s': candidate.pourcentExprimes,
                            '% Inscrits': candidate.pourcentInscrits
                        });
                    });
                });
                
                // Cr√©er une feuille Excel
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "R√©sultats");
                
                // G√©n√©rer le nom du fichier
                const fileName = `resultats-${currentCommune.replace(/\s+/g, '-').toLowerCase()}-${currentBureau === 'all' ? 'tous-bureaux' : 'bureau-' + currentBureau}-${new Date().toISOString().slice(0,10)}.xlsx`;
                
                // T√©l√©charger le fichier
                XLSX.writeFile(wb, fileName);
                
                trackUsage('export_completed', { 
                    format: 'excel', 
                    commune: currentCommune,
                    rows: exportData.length 
                });
                
            } catch (error) {
                console.error('Erreur lors de l\'export:', error);
                alert('Erreur lors de l\'export. V√©rifiez que la biblioth√®que XLSX est charg√©e.');
            }
        }
        
        // Track usage analytics
        function trackUsage(action, details = {}) {
            const usageData = {
                action,
                details,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                screenResolution: `${window.screen.width}x${window.screen.height}`,
                commune: currentCommune,
                bureau: currentBureau
            };
            
            // Enregistrer dans la console (√† remplacer par votre service d'analytics)
            console.log('Usage tracked:', usageData);
            
            // Vous pouvez remplacer ceci par un appel √† Google Analytics, Matomo, etc.
            // Exemple pour Google Analytics:
            // if (typeof gtag !== 'undefined') {
            //     gtag('event', action, details);
            // }
        }
        
        // Initialiser l'application au chargement de la page
        document.addEventListener('DOMContentLoaded', initApp);
        
        // Ajouter un message d'avertissement si XLSX n'est pas charg√©
        if (typeof XLSX === 'undefined') {
            console.warn('La biblioth√®que XLSX n\'est pas charg√©e. L\'export Excel ne fonctionnera pas.');
            
            // Charger XLSX dynamiquement si n√©cessaire
            document.getElementById('export-btn').addEventListener('click', function() {
                if (typeof XLSX === 'undefined') {
                    alert('La fonction d\'export Excel n√©cessite la biblioth√®que XLSX. Veuillez l\'inclure dans votre page.');
                }
            });
        }
    </script>
    
    <!-- Inclure la biblioth√®que SheetJS pour l'export Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</body>

</html>
